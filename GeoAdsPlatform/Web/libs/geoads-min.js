(function(b){var a=new Class({$events:null,init:function(){this.$events={};},on:function(c,d){this.$events[c]=this.$events[c]||[];this.$events[c].push(d);},fire:function(c,g){var f=this.$events[c];if(f){for(var d in f){var e=f[d];e.apply(this,[g]);}}},detach:function(c,f){var e=this.$events[c];for(var d=0;d<e.length;d++){if(e[d]==f){delete e[d];return;}}return;}});b.EventManager=a;}(GA));(function(b){var a=b.EventManager.extend({init:function(){this._parent();},onMessage:function(d,c){b.dispatcher.on(d,b.bind(c,this));},sendMessage:function(d,c){b.dispatcher.fire(d,c);}});b.MsgManager=a;b.dispatcher=new a();}(GA));(function(d){var a=null;var c=".page";var b=d.EventManager.extend({tableName:"",filters:[],rowCount:20,cluster:null,showLoading:false,tables:[],init:function(e){if(a){throw new Error("You can only create one instance of DataManager!");}this._parent();},geocode:function(e,h,f){var f=f||{};var g=new google.maps.Geocoder();g.geocode({address:e},d.bind(function(o,n){if(n==google.maps.GeocoderStatus.OK){if(h){var m=[];var q=-1;for(var p=0;p<o.length;p++){q++;m.push({index:q,lat:o[p].geometry.location.lat(),lon:o[p].geometry.location.lng(),address:o[p].formatted_address,bounds:[o[p].geometry.viewport.getSouthWest().lat(),o[p].geometry.viewport.getSouthWest().lng(),o[p].geometry.viewport.getNorthEast().lat(),o[p].geometry.viewport.getNorthEast().lng()]});}if(f.success){f.success.apply(this,[m]);}}else{var r=o[0].geometry.location.lat();var k=o[0].geometry.location.lng();var l=o[0].formatted_address;var j=[o[0].geometry.viewport.getSouthWest().lat(),o[0].geometry.viewport.getSouthWest().lng(),o[0].geometry.viewport.getNorthEast().lat(),o[0].geometry.viewport.getNorthEast().lng()];if(f.success){f.success.apply(this,[r,k,l,j]);}}}},this));},reverseGeocode:function(i,f,e){var e=e||{};var h=new google.maps.Geocoder();var g=new google.maps.LatLng(i,f);h.geocode({latLng:g},d.bind(function(l,k){if(k==google.maps.GeocoderStatus.OK){var j=l[0].formatted_address;var m=l[0].geometry.viewport;if(e.success){e.success.apply(this,[j,m]);}}},this));},geolocateUser:function(){if(navigator.geolocation){navigator.geolocation.getCurrentPosition(d.bind(function(e){this.reverseGeocode(e.coords.latitude,e.coords.longitude,{success:d.bind(function(f,g){this.geocodeBounds=[g.getSouthWest().lat(),g.getSouthWest().lng(),g.getNorthEast().lat(),g.getNorthEast().lng()];this.geocodeCenter=[e.coords.latitude,e.coords.longitude];var h={lat:e.coords.latitude,lon:e.coords.longitude,address:f,bounds:this.geocodeBounds};this.fire("userGeocoded",h);},this)});},this),d.bind(function(e){this.fire("userNotGeocoded");},this));}}});b.getInstance=function(){if(a){return a;}a=new b();return a;};d.DataManager=b;}(GA));(function(c){var a=null;var b=new Class({geoAdsPlatformUrl:"http://127.0.0.1:1314/",login:function(g,f,i,e){var d=this.geoAdsPlatformUrl+"login";var h="email="+g+"&"+"password="+f;jQuery.ajax({url:d,type:"POST",data:h,success:c.bind(function(j){if(j.GreatSuccess==false){e.apply(this,[]);}else{i.apply(this,[j]);}},this)});},saveAd:function(e,k,h,i,d,l,j){if(!e||!k||!h||!i||!d&&j){j.apply(this,[]);return;}var f=this.geoAdsPlatformUrl+"/ads/save";var g="name="+e+"&"+"description="+k+"&"+"radius="+h+"&"+"lat="+i+"&"+"lon="+d;jQuery.ajax({url:f,type:"POST",data:g,success:c.bind(function(m){if(!m||!m.GreatSuccess&&j){j.apply(this,[]);}else{if(l){l.apply(this,[]);}}},this),error:c.bind(function(m){if(j){j.apply(this,[]);}},this)});}});b.getInstance=function(){if(a){return a;}a=new b();return a;};c.AjaxManager=b;})(GA);(function(c){var b=null;var a=new Class({ad:{},geoAdsPlatformUrl:"http://127.0.0.1:1314/",init:function(){this.ajax=c.AjaxManager.getInstance();},setAdMapSettings:function(d,e){this.ad.center=d;this.ad.radius=e;},setAdInfoSettings:function(e,d){if(!e||!d){return;}this.ad.name=e;this.ad.description=d;},getAd:function(){return this.ad;},saveAd:function(){if(!this.ad||!this.ad.center||!this.ad.radius||!this.ad.name||!this.ad.description){return;}this.ajax.saveAd(this.ad.name,this.ad.description,this.ad.radius,this.ad.center.lat,this.ad.center.lon,function(){alert("Save ad Success!");},function(){alert("Save ad Fail!");});}});a.getInstance=function(){if(b){return b;}b=new a();return b;};c.AdManager=a;}(GA));(function(b){var a=b.MsgManager.extend({app:null,mustache:null,templates:null,init:function(c){this.mustache=b.mustache;this.templates=c.templates;this.container=c.container;this.renderContainer=c.renderContainer;this.hideOnStates=c.hideOnStates||[];this.formatRenderData=c.formatRenderData;this.dataManager=b.DataManager.getInstance();this.adManager=b.AdManager.getInstance();this.ajax=b.AjaxManager.getInstance();this.events=b.extend(this.events||{},c.events||{});this.parseEvents();this.register();},register:function(){},render:function(){},parseEvents:function(){var e=this.events||{};for(var c in e){for(var d in e[c]){var f=this[e[c][d]]||e[c][d];b.delegate(this.container,c,d,b.bind(f,this));}}},getDictionary:function(){return b.LanguageManager.getInstance().dictionary;}});b.View=a;}(GA));(function(b){var a=b.View.extend({events:{},init:function(c){this._parent(c);},register:function(){},render:function(){this.container.innerHTML=this.mustache(this.templates.main,{});return this;},});b.HomeView=a;}(GA));(function(c){var b=17;var a=c.View.extend({map:null,maxRadius:2000,zoom:b,events:{"#next-step":{click:"onNextStepClick"}},init:function(d){this._parent(d);this.dataManager.on("userGeocoded",c.bind(this.onUserGeocoded,this));this.dataManager.on("userNotGeocoded",c.bind(this.onUserNotGeocoded,this));this.markerInfo=d.markerInfo||{url:"images/orange-pin.png",position:{lat:15,lng:0}};this.radius=d.radius||100;if(this.radius>this.maxRadius){this.radius=this.maxRadius;}this.startZoom=d.startZoom||3;},register:function(){this.onMessage("drawMarker",this.onDrawMarker);this.onMessage("resizeMap",this.onResizeMap);},render:function(){var d={zoom:this.startZoom,center:new google.maps.LatLng(this.markerInfo.position.lat,this.markerInfo.position.lng),mapTypeId:google.maps.MapTypeId.ROADMAP,mapTypeControl:true,mapTypeControlOptions:{style:google.maps.MapTypeControlStyle.DEFAULT,position:google.maps.ControlPosition.TOP_RIGHT},panControl:false,zoomControl:false,streetViewControl:false,zoomControlOptions:{style:google.maps.ZoomControlStyle.SMALL},};
this.map=new google.maps.Map(this.renderContainer,d);return this;},centerAndZoom:function(d,e){if(!d||!d.lat||!d.lon||!e){return;}var d=new google.maps.LatLng(d.lat,d.lon);this.map.setCenter(d);this.map.setZoom(e);},drawMarker:function(d){this.markerInfo=d||this.markerInfo;if(!this.markerInfo){return;}if(!this.marker){this.createMarker(this.markerInfo);}else{this.marker.setPosition(new google.maps.LatLng(this.markerInfo.position.lat,this.markerInfo.position.lng));}this.centerAndZoom({lat:this.markerInfo.position.lat,lon:this.markerInfo.position.lng},this.zoom);this.drawCoverage();this.marker.adCoverage=this.adCoverage;this.adCoverage.bindTo("map",this.marker);this.adCoverage.bindTo("center",this.marker,"position");google.maps.event.addListener(this.marker,"dragend",c.bind(function(){this.drawCoverage();},this));},createMarker:function(d){this.marker=new google.maps.Marker({map:this.map,animation:google.maps.Animation.DROP,draggable:true,icon:d.url,position:new google.maps.LatLng(d.position.lat,d.position.lng)});},drawCoverage:function(){var d=this.marker.getPosition();if(!this.adCoverage){this.adCoverage=new google.maps.Circle({editable:true,center:d,radius:this.radius,strokeColor:"#008CE4",strokeOpacity:0.5,strokeWeight:1,fillColor:"#00A4E4",fillOpacity:0.3});}else{this.adCoverage.setCenter(d);}google.maps.event.addListener(this.adCoverage,"radius_changed",c.bind(function(e){if(this.adCoverage.radius>this.maxRadius){this.adCoverage.setRadius(this.maxRadius);}},this));this.adCoverage.setMap(this.map);google.maps.event.trigger(this.map,"resize");},onDrawMarker:function(e){if(!e||!e.lat||!e.lon){return;}this.zoom=b;var d={};d.url=this.markerInfo.url;d.position={};d.position.lat=e.lat;d.position.lng=e.lon;this.drawMarker(d);},onUserGeocoded:function(e){if(!e||!e.lat||!e.lon){return;}this.zoom=b;var d={};d.url=this.markerInfo.url;d.position={};d.position.lat=e.lat;d.position.lng=e.lon;this.drawMarker(d);},onUserNotGeocoded:function(d){this.zoom=3;},onResizeMap:function(d){google.maps.event.trigger(this.map,"resize");this.centerAndZoom({lat:this.markerInfo.position.lat,lon:this.markerInfo.position.lng},this.zoom);},onNextStepClick:function(d){var e=this.marker.getPosition();var f=Math.round(this.adCoverage.getRadius());this.adManager.setAdMapSettings({lat:e.lat(),lon:e.lng()},f);this.sendMessage("changeState",{state:c.App.States.INFO});},});c.MapView=a;}(GA));(function(g){var b="#home-item";var d="#login-item";var c="#register-item";var f="#publish-item";var e="#about-item";var a=g.View.extend({events:{".menu-item":{click:"onMenuItemClick"}},init:function(h){this._parent(h);},register:function(){this.onMessage("stateChanged",this.onStateChanged);},render:function(){this.container.innerHTML=this.mustache(this.templates.main,{});return this;},onStateChanged:function(h){if(h.currentState==g.App.States.HOME||h.currentState==g.App.States.LOGIN||h.currentState==g.App.States.REGISTER){g.removeClass(g.one(d,this.container),"hide");g.removeClass(g.one(c,this.container),"hide");g.removeClass(g.one(f,this.container),"hide");g.removeClass(g.one(e,this.container),"hide");}else{g.addClass(g.one(d,this.container),"hide");g.addClass(g.one(c,this.container),"hide");g.addClass(g.one(f,this.container),"hide");g.addClass(g.one(e,this.container),"hide");}},onMenuItemClick:function(h){var i=h.currentTarget.id;switch(i){case"home-item":this.sendMessage("changeState",{state:g.App.States.HOME});break;case"publish-item":this.sendMessage("changeState",{state:g.App.States.MAP});this.sendMessage("resizeMap");break;case"login-item":window.location.href="login";this.sendMessage("changeState",{state:g.App.States.LOGIN});break;case"register-item":window.location.href="register";this.sendMessage("changeState",{state:g.App.States.REGISTER});break;}}});g.MenuView=a;}(GA));(function(c){var a="#search-input";var b=c.View.extend({events:{"#search-btn":{click:"onSearch"},"#search-input":{keyup:"onKeyUp"},},init:function(d){this._parent(d);this.dataManager.on("userGeocoded",c.bind(this.onUserGeocoded,this));},register:function(){},render:function(){this.container.innerHTML=this.mustache(this.templates.main,{});return this;},search:function(d,e){this.searchInputText=d||this.getInputValue();if(!this.searchInputText){return;}this.dataManager.geocode(this.searchInputText,true,{success:c.bind(function(i){if(i.length==0){return;}var f=i[0].address;var g=i[0].lat;var h=i[0].lon;this.setInputValue(f);this.sendMessage("drawMarker",{lat:g,lon:h});},this)});},setInputValue:function(d){c.one(a,this.container).value=d;},getInputValue:function(){return c.one(a,this.container).value;},onSearch:function(d){this.search();},onKeyUp:function(d){if(d.keyCode==13){this.search();}},onUserGeocoded:function(d){if(!d||!d.address){return;}this.setInputValue(d.address);}});c.SearchView=b;}(GA));(function(d){var c="#company-name";var b="#keywords";var a=d.View.extend({events:{"#publish":{click:"onPublishClick"},"#previous-step":{click:"onPreviousStepClick"}},init:function(e){this._parent(e);},register:function(){},render:function(){this.container.innerHTML=this.mustache(this.templates.main,{});return this;},inputValid:function(e){var f=d.one(e,this.container).value;if(f.length>0){return true;}else{return false;}},onPreviousStepClick:function(e){this.sendMessage("changeState",{state:d.App.States.MAP});},onPublishClick:function(e){var g=d.one(c,this.container).value;var f=d.one(b,this.container).value;if(this.inputValid(c)&&this.inputValid(b)){this.adManager.setAdInfoSettings(g,f);this.adManager.saveAd();}}});d.InfoView=a;}(GA));(function(h){var g="#login-email";var f="#login-pass";var e="input-error";var b="The e-mail is not valid!";var d="The password is not valid!";var a="Sorry, your email or password are not valid!";var c=h.View.extend({events:{"#loginBtn":{click:"onLoginSubmitClick"},"#lostBtn":{click:"onLostPasswordClick"},".login-icon":{click:"onHomeClick"},"#registerBtn":{click:"onRegisterClick"}},init:function(i){this._parent(i);},register:function(){},render:function(i){this.container.innerHTML=this.mustache(this.templates.main,{errorMessage:this.errorMessage});
return this;},getEmail:function(){return h.one(g,this.container).value;},getPassword:function(){return h.one(f,this.container).value;},onLoginSubmitClick:function(i){if(!h.validateEmailInput(this.getEmail())){this.errorMessage=b;this.render();h.addClass(h.one(g,this.container),e);return;}else{h.removeClass(h.one(g,this.container),e);}if(!h.validatePasswordInput(this.getPassword())){this.errorMessage=d;this.render();h.addClass(h.one(f,this.container),e);return;}else{h.removeClass(h.one(f,this.container),e);}this.ajax.login(this.getEmail(),this.getPassword(),h.bind(function(){window.location.href="home";},this),h.bind(function(){this.errorMessage=a;this.render();h.addClass(h.one(g,this.container),e);h.addClass(h.one(f,this.container),e);},this));},onHomeClick:function(i){window.location.href="home";this.sendMessage("changeState",{state:h.App.States.HOME});},onRegisterClick:function(i){window.location.href="register";this.sendMessage("changeState",{state:h.App.States.REGISTER});}});h.LoginView=c;}(GA));(function(d){var g="#register-email";var c="#register-pass";var h="#register-pass-confirm";var e=".error-message";var i="input-error";var j="The e-mail is not valid!";var a="The password is not valid!";var f="The passwords don't match!";var b=d.View.extend({events:{"#registerBtn":{click:"onRegisterSubmitClick"},".login-icon":{click:"onHomeClick"}},init:function(k){this._parent(k);},register:function(){},render:function(k){this.container.innerHTML=this.mustache(this.templates.main,{errorMessage:this.errorMessage});return this;},getEmail:function(){return d.one(g,this.container).value;},getPassword:function(){return d.one(c,this.container).value;},getConfirmationPassword:function(){return d.one(h,this.container).value;},samePasswords:function(){var k=this.getPassword();var l=this.getConfirmationPassword();if(k==l){return true;}return false;},onRegisterSubmitClick:function(k){if(!d.validateEmailInput(this.getEmail())){d.addClass(d.one(g,this.container),i);this.errorMessage=j;this.render();return;}else{d.removeClass(d.one(g,this.container),i);}if(!d.validatePasswordInput(this.getPassword())){d.addClass(d.one(c,this.container),i);this.errorMessage=a;this.render();return;}else{d.removeClass(d.one(c,this.container),i);}if(!d.validatePasswordInput(this.getConfirmationPassword())){d.addClass(d.one(h,this.container),i);this.errorMessage=a;this.render();return;}else{d.removeClass(d.one(h,this.container),i);}if(!this.samePasswords()){this.errorMessage=f;this.render();return;}else{}},onHomeClick:function(k){window.location.href="home";this.sendMessage("changeState",{state:d.App.States.HOME});}});d.RegisterView=b;}(GA));(function(b){var a=b.MsgManager.extend({views:[],state:null,lastState:null,init:function(c){this._parent();this.state=c.state;this.language=c.language;this.addViews(c.views||[]);this.appReady=c.appReady;this.register();b.DataManager.getInstance().app=this;},addView:function(c){if(!c){return;}c.app=this;if(this.views.indexOf(c)==-1){this.views.push(c);}},addViews:function(c){for(var d=0;d<c.length;d++){this.addView(c[d]);}},removeView:function(c){},register:function(){this.onMessage("changeState",this.onChangeState);this.onMessage("reverseState",this.onReverseState);},start:function(){if(this.language){b.LanguageManager.getInstance().loadLanguage(this.language,b.bind(function(){this._start();},this));}else{this._start();}},_start:function(){for(var c=0;c<this.views.length;c++){this.views[c].render();}this.changeState(this.state||"home");if(this.appReady){this.appReady.call(this,[]);}},changeState:function(e,f){if(e==this.state&&this.lastState!=null){return;}this.lastState=this.state;this.state=e;for(var d=0;d<this.views.length;d++){var c=this.views[d];if(c.hideOnStates.indexOf(this.state)!=-1){this.hideView(c);}else{this.showView(c);}}this.sendMessage("stateChanged",{currentState:this.state,lastState:this.lastState});},hideView:function(c){b.addClass(c.container,"hide-view");this.sendMessage("hideView",c.container);},showView:function(c){b.removeClass(c.container,"hide-view");this.sendMessage("showView",c.container);},onChangeState:function(c){this.changeState(c.state);},onReverseState:function(c){this.changeState(this.lastState);}});b.App=a;b.App.States={};b.App.States.HOME="home";b.App.States.MAP="map";b.App.States.INFO="info";b.App.States.LOGIN="login";b.App.States.REGISTER="register";}(GA));